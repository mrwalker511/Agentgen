name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run TypeScript compiler
        run: npm run typecheck

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install Node dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Generate coverage report
        run: npm run test:coverage

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage/coverage-final.json
          fail_ci_if_error: false

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Check build artifacts
        run: |
          if [ ! -d "dist" ]; then
            echo "Build failed: dist directory not found"
            exit 1
          fi
          if [ ! -f "dist/cli/index.js" ]; then
            echo "Build failed: CLI entry point not found"
            exit 1
          fi

  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install Node dependencies
        run: npm ci

      - name: Build Agentgen
        run: npm run build

      - name: Test: Generate Python API project
        run: |
          node dist/cli/index.js new ./test-output/my-api \
            --pack python-api \
            --name my-api \
            --description "Test API" \
            --non-interactive

      - name: Verify generated project structure
        run: |
          if [ ! -f "test-output/my-api/pyproject.toml" ]; then
            echo "Failed: pyproject.toml not found"
            exit 1
          fi
          if [ ! -f "test-output/my-api/AGENT.md" ]; then
            echo "Failed: AGENT.md not found"
            exit 1
          fi
          echo "✓ Project structure verified"

      - name: Test: Update AGENT.md
        run: |
          # Add custom content to AGENT.md
          echo -e "\n## Custom Section\n\nThis should be preserved.\n" >> test-output/my-api/AGENT.md

          # Run update-agent
          node dist/cli/index.js update-agent ./test-output/my-api

          # Verify custom content is preserved
          if ! grep -q "Custom Section" test-output/my-api/AGENT.md; then
            echo "Failed: Custom content not preserved"
            exit 1
          fi
          echo "✓ AGENT.md update verified"

      - name: Test: Verify dependencies (skip tests)
        run: |
          cd test-output/my-api
          node ../../dist/cli/index.js verify-deps . --skip-tests

          # Check that verification report was created
          if [ ! -f "agentgen.verify.json" ]; then
            echo "Failed: Verification report not created"
            exit 1
          fi
          echo "✓ Dependency verification completed"
